
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE)
```


```{r }
#Author: Mark Dane, copyright 2015

source("MEPLINCSFunctions.R")

```



```{r setup,cache=FALSE}
library("ggplot2")
library("data.table")
library("MEMA")
library("grid")
library("knitr")
library("gplots")
library("RColorBrewer")
library(DT)
library(d3heatmap)
library(plotly)
library(Rtsne)
library(readxl)

#Setup colors for Barcode and text in all heatmaps
selDark2 <- colorRampPalette(brewer.pal(8,"Dark2"))
plateCol = selDark2(8)
hmcols<-colorRampPalette(c("blue","white","red"))(16)
l3 <- fread(paste0("../AnnotatedData/",cellLine, "_",ss,"_",drug,"_",rawDataVersion,"_",analysisVersion,"_Level3.txt"), showProgress = FALSE)
l4 <- fread(paste0("../AnnotatedData/",cellLine, "_",ss,"_",drug,"_",rawDataVersion,"_",analysisVersion,"_Level4.txt"), showProgress = FALSE)
barcodes <- sort(unique(l3$Barcode))

#Set a threshold for filtering wells on their QA score
wellQAThresh <- 0.6

#TODO: Read this from Level 3 data
lthresh <- 0.6

#Number of PCS components to use
nrPCs <- 9

#Z score threshold for extreme spot cell count
SCCZscoreThresh <- 3


#Make k parameter visible
k <- unique(l3$k)

if(!analysisVersion=="v1"){
  l3$OmeroDetailURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/img_detail/',l3$ImageID,'/"',' target="_blank">Omero</a>')
  l3$OmeroThumbnailURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/render_thumbnail/',l3$ImageID,'/"',' target="_blank">Omero</a>')
  l3$OmeroImageURL <- paste0('<a href="https://meplincs.ohsu.edu/webclient/render_image/',l3$ImageID,'/"',' target="_blank">Omero</a>')
}

```


#MEP-LINCS `r cellLine` `r ss` Analysis  
####date: `r Sys.Date()`

<br>

##Introduction  
The LINCS `r cellLine` `r ss` experiment was performed with cells grown in `r length(barcodes)` 8-well plates. The `r ss` staining set includes, DAPI, `r unique(l4$Endpoint488)`, `r unique(l4$Endpoint555)` and `r unique(l4$Endpoint647)`. Color images of the cells at each spot were gathered on a Nikon automated microscope. The CP Pipeline `r rawDataVersion` performed the segmentation and the analysis pipeline is `r analysisVersion`.

Intensity, position and morphology data are gathered for each cell, merged with the experiment metadata, normalized with `r unique(l3$NormMethod)`, filtered and summarized. 


```{r Filtering}

#Remove the fiducial and blank data
setkey(l3,ECMp)
l3F <- l3[!grepl("fiducial|Fiducial|blank|PBS",l3$ECMp),]

#Remove failed QA wells
#Read in manually cureated list
PoorQualityWells <- read_excel("~/GrayLabData/dane/MEP-LINCS/PoorQualityWells.xlsx")
PoorQualityWells$QA_LowWellQA <- TRUE
l3F <- l3F[,QA_LowWellQA :=NULL]
l3F <- merge(l3F,PoorQualityWells,by=c("Barcode","Well"),all=TRUE)
l3F$QA_LowWellQA[is.na(l3F$QA_LowWellQA)]<-FALSE
#Add flags for manually curated wells
l3F$QA_LowWellQA<-FALSE
#Delete wells that have been flagged for low well quality
l3F <- l3F[!l3F$QA_LowWellQA]
l3F <- l3F[l3F$QAScore>wellQAThresh]

#Combine FBS replicates
l3FFBS <- l3F
l3FFBS$Ligand[grepl("FBS",l3FFBS$Ligand)] <- gsub("_.*","",l3FFBS$Ligand[grepl("FBS",l3FFBS$Ligand)])
l4F <- createl4(l3FFBS,  seNames=c("DNA2N","SpotCellCount","EdU","MitoTracker","KRT","Lineage","Fibrillarin"))
#Add Robust Z Scores of the normalized Spot Cell Counts #across the entire staining set
l4F <- l4F[,Spot_PA_SpotCellCountLog2RUV3Loess_RobustZ := RZScore(Spot_PA_SpotCellCountLog2RUV3Loess)]

if (grepl("SS2|SS4",ss)){
  #Add Robust Z Score of the EdU Signal
  l4F <- l4F[,Nuclei_PA_Gated_EdUPositiveProportionRUV3Loess_RobustZ := RZScore(Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess)]
}

if (grepl("SS3|SS4",ss)){
  #Add Robust Z Scores of the normalized lineage ratios

  l4F <- l4F[, Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess_RobustZ:= RZScore(Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess)]
}

```




##Spot Cell Count Analysis
The spot cell count analysis identifies MEPs with extreme population sizes. The normalized spot cell counts in the plot below are summarized by the median and standard error of their replicates. Hovering over the the interactive plot below shows the MEP identities. Clicking and dragging over a section of the plot will zoom into the selected location. Double clicking on the zooomed plot will restore the original plot.

<br>



```{r SCCByMEPFull, fig.width=8, fig.height=6}
dt <- l4F

p <- ggplot(dt, aes(x =reorder(MEP, Spot_PA_SpotCellCountLog2RUV3Loess), y = Spot_PA_SpotCellCountLog2RUV3Loess))+
  geom_errorbar(aes(ymin=Spot_PA_SpotCellCountLog2RUV3Loess-Spot_PA_SpotCellCountLog2RUV3Loess_SE, ymax=Spot_PA_SpotCellCountLog2RUV3Loess+Spot_PA_SpotCellCountLog2RUV3Loess_SE), width=.01, colour="black") +
  xlab("MEP")+ylab("Normalized Spot Cell Count")+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by Normalized Spot Cell Count (Full dataset)")

p <- p + geom_point(aes(y=Spot_PA_SpotCellCountLog2RUV3Loess),colour = "darkblue", alpha = .5)

ggplotly(p)

```


###Normalized Spot Cell Counts

The interactive heatmaps below are arranged by unsupervised clustering of the rows and columns and colored by the normalized spot cell count. Clicking and dragging across any subsection will zoom in on that section. Double clicking on the zoomed image will return to the full heatmap.  

```{r SCCHeatmapFull, fig.width=8, fig.height=5}
#Cast to get ligands into columns
df <- dcast(data.frame(l4F[,list(ECMp,Ligand,Spot_PA_SpotCellCountLog2RUV3Loess,Barcode)]),ECMp~Ligand, value.var = "Spot_PA_SpotCellCountLog2RUV3Loess")

rownames(df) <- df$ECMp
df <- df[,!grepl("ECMp",names(df))]

try(d3heatmap(dfZoom(df, .05, .95), colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="5pt"), TRUE)

```

<br>

##Interactive Datatables   
The first datatable below shows the MEP summarized values while the second table shows the spot-level data. The spot-level datatable includes links to the images stored in OHSU's Omero database.  

The tables can be sorted by the values in any column, filtered by any search term and adjusted to display from 5 to 100 rows.  

A useful mining method to use the first table to identify a MEP of interest as this table uses robust methods to summarize the replicates, then view the individual replicate data and images in the second table.  

<br> 


```{r SCCTable}
if(any(grepl("SS1",ss))){
  colNames <- c("MEP", "ECMp", "Ligand", "Spot_PA_SpotCellCountLog2RUV3Loess", "Spot_PA_SpotCellCount", "Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess","Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUV3Loess", "Spot_PA_ReplicateCount")
  colNamesDisplay <- c("MEP","ECMp","Ligand","Normed Spot Cell Count ","Spot Cell Count","Normed DNA 2N Prop.","Normed MitoTracker Intnsity","Replicate Count")
} else if (any(grepl("SS2|SS4|SS6",ss))){
  colNames <- c("MEP", "ECMp", "Ligand", "Spot_PA_SpotCellCountLog2RUV3Loess", "Spot_PA_SpotCellCount", "Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess","Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess", "Spot_PA_ReplicateCount")
  colNamesDisplay <- c("MEP","ECMp","Ligand","Normed Spot Cell Count ","Spot Cell Count","Normed DNA 2N Prop.","Normed EdU+ Prop.","Replicate Count")
} else if (any(grepl("SS3|SS4",ss))){
  if (cellLine=="MCF10A"){
    colNames <- c("MEP", "ECMp", "Ligand", "Spot_PA_SpotCellCountLog2RUV3", "Spot_PA_SpotCellCount","Nuclei_PA_Cycle_DNA2NProportionLogitRUV3","Cytoplasm_PA_Intensity_LineageRatioLog2RUV3", "Spot_PA_ReplicateCount")
    colNamesDisplay <- c("MEP","ECMp","Ligand","Normed Spot Cell Count ","Spot Cell Count","Normed DNA 2N Prop.","Normed Lineage Ratio","Replicate Count")
  }else{
    colNames <- c("MEP", "ECMp", "Ligand", "Spot_PA_SpotCellCountLog2RUV3Loess", "Spot_PA_SpotCellCount","Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess","Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess", "Spot_PA_ReplicateCount")
    colNamesDisplay <- c("MEP","ECMp","Ligand","Normed Spot Cell Count ","Spot Cell Count","Normed DNA 2N Prop.","Normed Lineage Ratio","Replicate Count")
    
  }
} else stop("Unknown staining set name")

dt <- setorder(l4F,-Spot_PA_SpotCellCountLog2RUV3Loess)
datatable(format(dt[, colNames, with=FALSE], digits=2, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames = colNamesDisplay)

colNamesSpots <- c(colNames[1],"ArrayRow","ArrayColumn","OmeroDetailURL",colNames[2:length(colNames)])
colNamesDisplaySpots <- c(colNamesDisplay[1],"ArrayRow","ArrayColumn","Image Link",colNamesDisplay[2:length(colNamesDisplay)])
setkey(dt,"Ligand")

dt <- setorder(l3F, -Spot_PA_SpotCellCountLog2RUV3Loess)
datatable(format(dt[,colNamesSpots, with=FALSE], digits=2, scientific = FALSE, nsmall=0), options = list(pageLength = 5), colnames =colNamesDisplaySpots, escape = FALSE)

```

<br>

##DNA Content Analysis

All cells are stained with DAPI and autogated as DNA 2N or 4N. The proportion of 2N and 4N cells at each spot is calculated and will always sum to 1. The proportions are logit transformed then RUV3 and loess normalized. Lower normalized values have smaller 2N populations and therefore larger 4N populations.

<br>

```{r DNA2NByMEPFull, fig.width=8, fig.height=6}

dt <- l4F

p <- ggplot(dt, aes(x =reorder(MEP, Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess), y = Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess))+
  geom_errorbar(aes(ymin=Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess-Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess_SE, ymax=Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess+Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess_SE), width=.01, colour="black") +
  xlab("MEP")+ylab("Normalized DNA 2N Proportion Ratio")+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by Normalized DNA Proportion (Full dataset)")

p <- p + geom_point(aes(y=Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess),colour = "blue", alpha = .5)

ggplotly(p)

```

<br>

###Normalized DNA 2N Heatmaps

The interactive heatmaps below are arranged by unsupervised clustering of the rows and columns and colored by the normalized DNA 2N proportions. Clicking and dragging across any subsection will zoom in on that section. Double clicking on the zoomed image will return to the full heatmap.    

```{r DNA2NHeatmapFull, fig.width=8, fig.height=5}

#Cast again to get ligands into columns
df <- dcast(data.frame(l4F[,list(ECMp,Ligand,Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess,Barcode)]),ECMp~Ligand, value.var = "Nuclei_PA_Cycle_DNA2NProportionLogitRUV3Loess")

rownames(df) <- df$ECMp
df <- df[,!grepl("ECMp",names(df))]

try(d3heatmap(dfZoom(df, .05, .95), colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="5pt"), TRUE)

```



```{r, child='MEP-LINCS_MitoText.Rmd', eval=grepl("SS1",ss)}
```

<br>

```{r MitoTrackerByMEPFull, eval=grepl("SS1",ss), fig.width=8, fig.height=6}
dt <- l4F

yLimits <- quantile(c(dt$Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUV3Loess-dt$Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUV3Loess_SE, dt$Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUV3Loess+dt$Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUV3Loess_SE), probs=c(.002, .998))

p <- ggplot(dt, aes(x =reorder(MEP, Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUV3Loess), y = Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUV3Loess))+
  geom_errorbar(aes(ymin=Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUV3Loess-Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUV3Loess_SE, ymax=Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUV3Loess+Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUV3Loess_SE), width=.01, colour="black") +
  coord_cartesian(ylim=yLimits)+
  xlab("MEP")+ylab("Normalized MitoTracker Intensity Ratio")+
  geom_point(colour = "green", alpha = .5)+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by Normalized MitoTracker Intensity with SE Bars (Full dataset)")

ggplotly(p)
```


```{r MitotrackerHeatmapFull, eval=grepl("SS1",ss), fig.width=8, fig.height=5}

#Cast to get ligands into columns
df <- dcast(data.frame(l4F[,list(ECMp,Ligand,Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUV3Loess,Barcode)]),ECMp~Ligand, value.var = "Cytoplasm_CP_Intensity_MedianIntensity_MitoTrackerLog2RUV3Loess")

rownames(df) <- df$ECMp
df <- df[,!grepl("ECMp",names(df))]

try(d3heatmap(dfZoom(df, .05, .95), colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="5pt"), TRUE)

```


```{r, child='MEP-LINCS_ProliferationText.Rmd', eval=grepl("SS2|SS4",ss)}
```



```{r NormedProliferationByMEPFull,eval=grepl("SS2|SS4|SS6",ss), fig.width=8, fig.height=6}

dt <- l4F

p <- ggplot(dt, aes(x =reorder(MEP, Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess), y = Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess))+
  geom_errorbar(aes(ymin=Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess-Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess_SE, ymax=Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess+Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess_SE), width=.01, colour="black") +
  xlab("MEP")+ylab("Normalized EdU+ Proportion Ratio")+
  geom_point(colour = "red", alpha = .5)+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by Normalized EdU+ Proportion (Full Dataset)")

ggplotly(p)
```



```{r, child='MEP-LINCS_ProliferationHeatMapsText.Rmd', eval=grepl("SS2|SS4",ss)}
```


```{r EdUHeatmapFull, fig.width=8, fig.height=5, eval=grepl("SS2|SS4|SS6",ss)}

#Cast to get ligands into columns
df <- dcast(data.frame(l4F[,list(ECMp,Ligand,Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess,Barcode)]),ECMp~Ligand, value.var = "Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess")

rownames(df) <- df$ECMp
df <- df[,!grepl("ECMp",names(df))]


try(d3heatmap(dfZoom(df, .01, .99), colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="5pt"), TRUE)

```


```{r EdUBoxplotsFull, fig.width=8, fig.height=5, eval=grepl("SS2|SS4|SS6",ss)}

p <- ggplot(l4F, aes(x=Ligand, y=Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess))+
  geom_boxplot(outlier.colour = NA, fill=NA)+geom_jitter(aes(colour=ECMp),size=rel(.4))+
  guides(colour=FALSE)+
  xlab("Ligand")+ylab("Normalized EdU+\n(Logit)")+
  ggtitle("MEP EdU+ Response by Ligand")+
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=rel(.7)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(1)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
  
print(p)
ggplotly(p, tooltip="colour")

```


```{r, child='MEP-LINCS_LineageText.Rmd',eval=grepl("SS3|SS4",ss)}
```

```{r LineageRatioByMEP,eval=grepl("SS3|SS4",ss), fig.width=8, fig.height=6}

dt <- l4F

p <- ggplot(dt, aes(x =reorder(MEP, Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess), y = Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess))+
  geom_errorbar(aes(ymin=Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess-Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess_SE, ymax=Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess+Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess_SE), width=.01, colour="black") +
  xlab("MEP")+ylab("Normalized Logged Lineage Ratio")+
  geom_point(colour = "blue", alpha = .5)+
  theme( axis.text.x=element_blank(), axis.ticks=element_blank(),  panel.grid.major = element_blank())+
  ggtitle("MEPs Ordered by Normalized Lineage Ratio with SE Bars")

ggplotly(p)
```



```{r LineageMarkers, echo=FALSE, fig.width=8, fig.height=6,eval=grepl("SS3|SS4",ss)}

dt <- l4F

p <- ggplot(dt, aes(x=Cytoplasm_CP_Intensity_MedianIntensity_KRT5Log2RUV3Loess, y = Cytoplasm_CP_Intensity_MedianIntensity_KRT19Log2RUV3Loess, colour = Ligand))+
  geom_point(alpha=.5)+
  guides(colour=FALSE)+
  xlab("Normalized KRT5 Median Intensity")+ylab("Normalized KRT19 Median Intensity")+
  ggtitle("Normalized MEP Lineage Marker Intensities by Ligand")
(gg <- ggplotly(p))
```


```{r LineagRatioHeatmapFull, fig.width=8, fig.height=5, eval=grepl("SS3|SS4",ss)}

#Cast to get ECMps in rows and ligands into columns
df <- dcast(data.frame(l4F[,list(ECMp,Ligand, Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess,Barcode)]),ECMp~Ligand, value.var = "Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess")

rownames(df) <- df$ECMp
df <- df[,!grepl("ECMp",names(df))]


try(d3heatmap(dfZoom(df, 0.02, 1), colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="5pt"), TRUE)

```


```{r EdUvsLineageMarkers, echo=FALSE, fig.width=8, fig.height=6,eval=grepl("SS4",ss)}

dt <- l4

p <- ggplot(dt, aes(x=Cytoplasm_PA_Intensity_LineageRatioLog2RUV3Loess, y = Nuclei_PA_Gated_EdUPositiveProportionLogitRUV3Loess, colour = Ligand))+
  geom_point(alpha=.5)+
  guides(colour=FALSE)+
  xlab("Lineage Ratio")+ylab("EdU Proliferation")+
  ggtitle("EdU vs Lineage by Ligand")
(gg <- ggplotly(p))
```

##Unbiased Analysis

The unbiased analysis method is:  
Median summarize the cell level data at each spot  
Normalize the spot level data using RUV3 and loess methods  
Median summarize the normalized replicate spot values to the MEP level  
Perform hierarchical clustering on a curated feature vector of MEP intensities and morphologies  

The heatmap below is arranged by unsupervised clustering on the euclidean distance between the non-linearly compressed, scaled feature vectors. The rows are MEPs and the columns are the features. The squares are colored by the normalized MEP feature values.  

Clicking and dragging will zoom in on a section. Double clicking on the zoomed image will return to the full heatmap. This enables identifying MEPS that elicit similar responses on endpoints of interest.  

<br> 

```{r}

lowQALigands <- unique(l3$Ligand[l3$QA_LowWellQA])
fvDT <- filterl4RUV3(l4, lowQALigands)
setkey(fvDT, MEP)
fvDT <- fvDT[!grepl("FBS|Fiducial|fiducial|blank|PBS",fvDT$MEP),]
fvDT <- fvDT[,Barcode := NULL]

#Shorten the feature names
setnames(fvDT,grep("Barcode|MEP",colnames(fvDT), value = TRUE, invert = TRUE),gsub(".*_","",gsub("RUV3Loess","",grep("Barcode|MEP",colnames(fvDT), value = TRUE, invert = TRUE))))
#Remove when not needed
if("2NProportion" %in% colnames(fvDT)) setnames(fvDT,"2NProportion","DNA2NProportion")

#Convert to dataframe for use in D3heatmap
fvDT <- data.frame(fvDT)
rownames(fvDT) <- fvDT$MEP

fvDT <- fvDT[,!(names(fvDT) %in% c("MEP"))]
```


```{r, fig.height=8, fig.width=7, eval = TRUE}
fvDTC <- apply(fvDT,2,fvZoom, min=.02, max=.98)
try(d3heatmap(fvDTC, scale="column", colors=hmcols, xaxis_font_size="6pt", yaxis_font_size="4pt", show_grid = FALSE), TRUE)

```


```{r createtSNE, eval=FALSE}

tSNEParameters <- grep("MEP|Ligand|ECMp|Replicate|Barcode",colnames(filterl4RUV3(l4, lowQALigands)), invert=TRUE, value=TRUE)
data_matrix <- scale(as.matrix(dt[,tSNEParameters, with=FALSE]))

set.seed(1234)
data_tsne <- Rtsne(data_matrix, perplexity = 15)
dtt <- cbind(dt,data_tsne$Y)

```

```{r plottSNEBarcode,fig.width=4, fig.height=3, eval=FALSE}

p <- ggplot(dtt, aes_string(x="V1", y="V2", colour = "Barcode"))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot of Barcode"))+
  #scale_colour_gradient(low="black",high="red",oob = scales::squish)+
  guides(colour = guide_legend(title.theme = element_text(angle=0, size=12),override.aes = list(size=rel(.7),alpha=1)))
print(p)

```


```{r plottSNEFeatures,fig.width=3, fig.height=3, eval=FALSE}

tmp <- lapply(c(tSNEParameters),function(sigName){
  p <- ggplot(dtt, aes_string(x="V1", y="V2", colour = paste(sigName)))+
    geom_point(size=rel(.2), alpha=.5)+
    ggtitle(paste("tSNE plot of",sigName))+
    scale_colour_gradient(low="black",high="red",oob = scales::squish)+
    guides(colour = FALSE)+
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
  print(p)
})

```


```{r ggplotlytSNEMEPs,fig.width=6, fig.height=6, eval=FALSE}

p <- ggplot(dtt, aes_string(x="V1", y="V2", colour = "ECMp"))+
  geom_point(size=rel(1.2), alpha=.5)+
  ggtitle(paste("tSNE plot by ECMp"))+
  guides(colour = FALSE)+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))

(gg <- ggplotly(p))

p <- ggplot(dtt, aes_string(x="V1", y="V2", colour = "Ligand"))+
  geom_point(size=rel(1.2), alpha=.5)+
  ggtitle(paste("tSNE plot by Ligand"))+
  guides(colour = FALSE)+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
(gg <- ggplotly(p))
```

```{r plottSNEMEPs,fig.width=6, fig.height=6, eval=FALSE }
p <- ggplot(dtt, aes_string(x="V1", y="V2", colour = "MEP"))+
  geom_point(size=rel(.2), alpha=.5)+
  ggtitle(paste("tSNE plot by MEP"))+
  guides(colour = FALSE)+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), axis.text.y = element_text(angle = 0, vjust = 0.5, hjust=1, size=rel(1)), plot.title = element_text(size = rel(.5)),legend.text=element_text(size = rel(1)),legend.title=element_text(size = rel(1)))
print(p)

```


